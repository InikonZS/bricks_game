(()=>{"use strict";var t=function(){return(t=Object.assign||function(t){for(var o,n=1,e=arguments.length;n<e;n++)for(var i in o=arguments[n])Object.prototype.hasOwnProperty.call(o,i)&&(t[i]=o[i]);return t}).apply(this,arguments)},o=function(){function o(t,o,i,r){var s=this;this.field=new n(t,o,i,r),this.stackList=new e(t,o,i),this.field.onReverted=function(t){s.stackList.findByCell(t).push(t.color)}}return o.prototype.move=function(o){var n=this.stackList.stacks[o];this.field.isAvailableLine(n.direction,n.initialPosition)&&this.field.putCell(new r(n.pop(),n.direction,t({},n.initialPosition)))},o.prototype.processSteps=function(t){var o=this;o.field.processStep()?t.onStep((function(){o.processSteps(t)})):t.onStep((function(){t.onFinish()}))},o.prototype.checkFigure=function(t){},o}(),n=function(){function t(t,o,n,e){this.cells=[],this.breakFigureLength=e,this.width=t,this.height=o;for(var i=0;i<10;i++){var s=new r(Math.floor(Math.random()*n),0,{y:Math.floor(Math.random()*t),x:Math.floor(Math.random()*o)});this.putCell(s)}}return t.prototype.putCell=function(t){return this.cells.push(t),t},t.prototype.revertCell=function(t){return this.cells=this.cells.filter((function(o){return o!=t})),t},t.prototype.isInsideField=function(t){return t.x>=0&&t.y>=0&&t.y<this.width&&t.x<this.height},t.prototype.processStep=function(){var t=this,o=!1;return this.cells.forEach((function(n){var e=n.getNextPosition();null==t.getCell(e)&&(t.isInsideField(e)?n.position=e:(t.revertCell(n),t.onReverted(n)),o=!0)})),0==o&&this.cells.forEach((function(n){var e=t.checkFigure(n.position,n.color);e.length>=t.breakFigureLength&&(t.removeFigure(e),o=!0)})),o},t.prototype.getIndex=function(t,o){return this.cells.findIndex((function(n){return n.position.x==t&&n.position.y==o}))},t.prototype.getCell=function(t){return this.cells[this.getIndex(t.x,t.y)]},t.prototype.checkFigure=function(t,o){var n=this,e=this.cells.map((function(t){return{color:t.color,generation:Number.MAX_SAFE_INTEGER}})),i=[{x:0,y:1},{x:1,y:0},{x:-1,y:0},{x:0,y:-1}],r=function(t,s,c){var l=[];return t.forEach((function(t){i.forEach((function(i){var r={x:t.x+i.x,y:t.y+i.y},u=e[n.getIndex(r.x,r.y)];u&&u.generation>s&&u.color==o&&(l.push(r),u.generation=s,c.push(r))}))})),l.length?r(l,s+1,c):c};return r([t],0,[])},t.prototype.removeFigure=function(t){var o=this,n=[];t.forEach((function(t){var e=o.getCell(t);e&&n.push(e)})),this.cells=this.cells.filter((function(t){return!n.includes(t)}))},t.prototype.isAvailableLine=function(t,o){return!(!this.cells.find((function(n){return(1==t||4==t)&&n.position.x==o.x||(2==t||3==t)&&n.position.y==o.y}))||this.getCell(o))},t}(),e=function(){function t(t,o,n){this.stacks=[];for(var e=0;e<2*(t+o);e++){var r=new i(n),s=this.getDirection(e,t,o);r.direction=s,r.initialPosition=this.getInitial(e,t,o);for(var c=0;c<3;c++)r.push(Math.floor(Math.random()*n));this.stacks.push(r)}}return t.prototype.getDirection=function(t,o,n){return t<n?1:t<o+n?2:t<2*o+n?3:4},t.prototype.getInitial=function(t,o,n){return t<n?{x:Math.floor(t%o),y:0}:t<o+n?{x:0,y:Math.floor((t-o)%n)}:t<2*o+n?{x:o-1,y:Math.floor((t-o-n)%n)}:{x:Math.floor(t%o),y:n-1}},t.prototype.findByCell=function(t){return this.stacks.find((function(o){return o.initialPosition.x==t.position.x&&o.initialPosition.y==t.position.y&&o.direction==[0,4,3,2,1][t.direction]}))},t}(),i=function(){function t(t){this.cells=[],this.stackLength=3,this.colorsCount=t}return t.prototype.pop=function(){var t=this.cells.pop();return this.cells.unshift(Math.floor(Math.random()*this.colorsCount)),t},t.prototype.push=function(t){return this.cells=this.cells.slice(this.cells.length+1-this.stackLength),this.cells.push(t)},t}(),r=function(){function t(t,o,n){this._color=t,this._direction=o,this.position=n}return t.prototype.setDirection=function(t){this._direction=t},t.prototype.getNextPosition=function(){var t=[{x:0,y:0},{x:0,y:1},{x:1,y:0},{x:-1,y:0},{x:0,y:-1}][this._direction];return{x:this.position.x+t.x,y:this.position.y+t.y}},Object.defineProperty(t.prototype,"color",{get:function(){return this._color},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"direction",{get:function(){return this._direction},enumerable:!1,configurable:!0}),t}();const s=function(t,o,n,e){void 0===o&&(o="div"),void 0===n&&(n=""),void 0===e&&(e="");var i=document.createElement(o);i.className=n,i.textContent=e,t&&t.append(i),this.node=i};var c,l=(c=function(t,o){return(c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,o){t.__proto__=o}||function(t,o){for(var n in o)Object.prototype.hasOwnProperty.call(o,n)&&(t[n]=o[n])})(t,o)},function(t,o){if("function"!=typeof o&&null!==o)throw new TypeError("Class extends value "+String(o)+" is not a constructor or null");function n(){this.constructor=t}c(t,o),t.prototype=null===o?Object.create(o):(n.prototype=o.prototype,new n)}),u=function(t){function o(o,n,e,i){var r=this,c=n.direction;return(r=t.call(this,o,"div",2==c||3==c?"row":"row row__vertical")||this).cellViews=[],r.stackModel=n,r.colors=e,n.cells.forEach((function(t,o){var n=new s(r.node,"div","cell cell__stack");n.node.onclick=function(){i()},r.cellViews.push(n)})),r}return l(o,t),o.prototype.update=function(){var t=this;this.cellViews.forEach((function(o,n){var e=t.stackModel.direction,i=2==e||1==e?n:t.stackModel.cells.length-1-n,r=t.stackModel.cells[i];o.node.style.backgroundColor=t.colors[r]}))},o}(s),a=function(t){function o(o,n,e){var i=t.call(this,o)||this;i.fieldModel=e,i.colors=n,i.cells=[];for(var r=0;r<e.width;r++){for(var c=new s(i.node,"div","row"),l=[],u=0;u<e.height;u++){var a=new s(c.node,"div","cell cell__field");l.push(a)}i.cells.push(l)}return i}return l(o,t),o.prototype.update=function(){var t=this;this.cells.forEach((function(t){return t.forEach((function(t){t.node.style.backgroundColor="#fff",t.node.textContent=""}))})),this.fieldModel.cells.forEach((function(o){var n=t.cells[o.position.y][o.position.x];n.node.style.backgroundColor=t.colors[o.color],n.node.textContent=["","\\/",">","<","/\\"][o.direction]}))},o}(s),f=function(t){function o(o,n){var e=t.call(this,o,"div","grid_wrapper")||this;e.colors=["#f99","#9f9","#99f","#f4f","#df0","#f90"],e.stakes=[];for(var i=[],r=0;r<9;r++)i.push(new s(e.node,"div","grid_zone"));for(var c=function(t){var o=new s(i[[1,3,5,7][t-1]].node,"div",1==t||4==t?"row":"row row__vertical");n.stackList.stacks.forEach((function(n,i){if(n.direction==t){var r=new u(o.node,n,e.colors,(function(){e.handleMove(i)}));e.stakes.push(r)}}))},l=1;l<=4;l++)c(l);return e.fieldView=new a(i[4].node,e.colors,n.field),e.update(),e}return l(o,t),o.prototype.handleMove=function(t){var o=this;h.move(t);var n=0;h.processSteps({onStep:function(t){setTimeout((function(){o.update(),n=100,t()}),n)},onFinish:function(){0==h.field.cells.length&&console.log("win")}})},o.prototype.update=function(){this.stakes.forEach((function(t){return t.update()})),this.fieldView.update()},o}(s),h=new o(8,8,6,3);new f(document.querySelector("#app"),h),window.app=h,console.log("App started")})();
//# sourceMappingURL=main.js.map